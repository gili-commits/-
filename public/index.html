<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¢×¨×›×ª × ×™×”×•×œ ×©×›×™×¨×•×™×•×ª</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      direction: rtl;
    }
    header {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      padding: 18px 30px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    header h1 { font-size: 1.5rem; font-weight: 700; }
    header span { font-size: 1.8rem; }

    nav {
      background: #16213e;
      display: flex;
      gap: 4px;
      padding: 0 20px;
    }
    nav button {
      background: none;
      border: none;
      color: #aaa;
      padding: 12px 18px;
      cursor: pointer;
      font-size: 0.9rem;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    nav button:hover { color: white; }
    nav button.active { color: #e94560; border-bottom-color: #e94560; }

    .container { max-width: 1200px; margin: 0 auto; padding: 24px 20px; }

    .page { display: none; }
    .page.active { display: block; }

    /* Summary cards */
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border-right: 4px solid #e94560;
    }
    .card.green { border-right-color: #2ecc71; }
    .card.orange { border-right-color: #f39c12; }
    .card.blue { border-right-color: #3498db; }
    .card .label { font-size: 0.8rem; color: #888; margin-bottom: 6px; }
    .card .value { font-size: 2rem; font-weight: 700; color: #1a1a2e; }
    .card .sub { font-size: 0.75rem; color: #aaa; margin-top: 4px; }

    /* Table */
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 14px;
      color: #1a1a2e;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .table-wrap { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden; }
    table { width: 100%; border-collapse: collapse; }
    th {
      background: #f8f9fa;
      padding: 12px 16px;
      text-align: right;
      font-size: 0.82rem;
      color: #666;
      font-weight: 600;
      border-bottom: 1px solid #eee;
    }
    td {
      padding: 13px 16px;
      font-size: 0.88rem;
      border-bottom: 1px solid #f5f5f5;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge.active { background: #d4f5e2; color: #1a7a45; }
    .badge.expired { background: #fde8e8; color: #c0392b; }
    .badge.soon { background: #fef3cd; color: #856404; }

    /* Buttons */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary { background: #e94560; color: white; }
    .btn-primary:hover { background: #c0392b; }
    .btn-secondary { background: #3498db; color: white; }
    .btn-secondary:hover { background: #2980b9; }
    .btn-success { background: #2ecc71; color: white; }
    .btn-success:hover { background: #27ae60; }
    .btn-danger { background: #e74c3c; color: white; font-size: 0.78rem; padding: 5px 10px; }
    .btn-sm { padding: 5px 10px; font-size: 0.78rem; }

    /* Forms */
    .form-box {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 24px;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 14px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    .form-group label { font-size: 0.82rem; color: #555; font-weight: 500; }
    .form-group input, .form-group select {
      padding: 9px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      outline: none;
      transition: border 0.2s;
    }
    .form-group input:focus, .form-group select:focus { border-color: #e94560; }

    /* Scan results */
    .scan-result {
      background: white;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.06);
      border-right: 4px solid #3498db;
    }
    .scan-result h4 { font-size: 0.95rem; margin-bottom: 8px; color: #1a1a2e; }
    .scan-result .meta { font-size: 0.8rem; color: #777; margin-bottom: 8px; }
    .scan-result .inline-form { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .scan-result .inline-form input {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.82rem;
      width: 140px;
    }
    .scan-result .inline-form input.wide { width: 200px; }

    /* Alert */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 0.88rem;
    }
    .alert-warning { background: #fff3cd; color: #856404; border-right: 4px solid #f39c12; }
    .alert-success { background: #d4edda; color: #155724; border-right: 4px solid #2ecc71; }

    /* Empty state */
    .empty { text-align: center; padding: 40px; color: #aaa; }
    .empty .icon { font-size: 3rem; margin-bottom: 10px; }

    /* Toolbar */
    .toolbar { display: flex; gap: 10px; margin-bottom: 16px; align-items: center; }
    .toolbar input {
      padding: 8px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.88rem;
      outline: none;
      flex: 1;
      max-width: 300px;
    }

    /* Expiring soon highlight */
    tr.expiring-soon td { background: #fffbf0; }
    tr.expired-row td { background: #fff8f8; }

    /* Payments page */
    .contract-selector {
      background: white;
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .contract-selector label { font-size: 0.85rem; color: #555; font-weight: 500; white-space: nowrap; }
    .contract-selector select {
      padding: 9px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.9rem;
      outline: none;
      flex: 1;
      min-width: 220px;
      max-width: 420px;
    }
    .contract-selector select:focus { border-color: #e94560; }

    .contract-info-bar {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white;
      border-radius: 12px;
      padding: 16px 24px;
      margin-bottom: 20px;
      display: flex;
      gap: 28px;
      flex-wrap: wrap;
      align-items: center;
    }
    .contract-info-bar .info-item { display: flex; flex-direction: column; gap: 2px; }
    .contract-info-bar .info-label { font-size: 0.72rem; color: #aaa; }
    .contract-info-bar .info-val { font-size: 1rem; font-weight: 600; }

    /* Sub-tabs */
    .sub-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 18px;
      border-bottom: 2px solid #eee;
    }
    .sub-tab {
      background: none;
      border: none;
      padding: 10px 18px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #888;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .sub-tab:hover { color: #1a1a2e; }
    .sub-tab.active { color: #e94560; border-bottom-color: #e94560; font-weight: 600; }

    .sub-page { display: none; }
    .sub-page.active { display: block; }

    /* Payment summary chips */
    .pay-summary {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .pay-chip {
      padding: 10px 18px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .pay-chip.paid   { background: #d4f5e2; color: #1a7a45; }
    .pay-chip.unpaid { background: #fef3cd; color: #856404; }
    .pay-chip.late   { background: #fde8e8; color: #c0392b; }
    .pay-chip.total  { background: #e8f4fd; color: #1a5276; }

    /* Event type badges */
    .event-type {
      display: inline-block;
      padding: 2px 9px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .event-type.maintenance  { background: #fde8e8; color: #c0392b; }
    .event-type.rent-increase { background: #fef3cd; color: #856404; }
    .event-type.notice       { background: #d4f5e2; color: #1a7a45; }
    .event-type.payment-issue { background: #f5d5f5; color: #7d3c98; }
    .event-type.other        { background: #eee; color: #555; }

    .add-form-inline {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      display: none;
    }
    .add-form-inline.open { display: block; }
    .add-form-inline .form-row { margin-bottom: 10px; }
    .add-form-inline textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.88rem;
      resize: vertical;
      min-height: 64px;
      font-family: inherit;
      outline: none;
    }
    .add-form-inline textarea:focus { border-color: #e94560; }

    /* Contract detail page */
    .back-bar {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 20px;
    }
    .back-bar button {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 7px 14px;
      cursor: pointer;
      font-size: 0.88rem;
      color: #555;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .back-bar button:hover { background: #f0f2f5; border-color: #bbb; }
    .back-bar h2 { font-size: 1.2rem; color: #1a1a2e; }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 16px;
    }
    .detail-field { display: flex; flex-direction: column; gap: 4px; }
    .detail-field .df-label { font-size: 0.75rem; color: #888; font-weight: 500; text-transform: uppercase; letter-spacing: 0.03em; }
    .detail-field .df-value { font-size: 1rem; color: #1a1a2e; font-weight: 600; }

    .detail-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 22px;
    }
  </style>
</head>
<body>

<header>
  <span>ğŸ¢</span>
  <h1>××¢×¨×›×ª × ×™×”×•×œ ×©×›×™×¨×•×™×•×ª</h1>
  <button onclick="window.open('http://localhost:3000','_blank')" style="margin-right:auto; background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.25); color:white; padding:7px 14px; border-radius:8px; cursor:pointer; font-size:0.82rem; display:flex; align-items:center; gap:6px;">
    â†— ×¤×ª×— ×‘×“×¤×“×¤×Ÿ
  </button>
</header>

<nav>
  <button class="active" onclick="showPage('dashboard')">×“×©×‘×•×¨×“</button>
  <button onclick="showPage('contracts')">×—×•×–×™×</button>
  <button onclick="showPage('payments')">×ª×©×œ×•××™× ×•××™×¨×•×¢×™×</button>
  <button onclick="showPage('scan')">×¡×¨×™×§×ª PDF</button>
  <button onclick="showPage('add')">×”×•×¡×£ ×—×•×–×”</button>
</nav>

<div class="container">

  <!-- DASHBOARD -->
  <div id="page-dashboard" class="page active">
    <div class="cards" id="summary-cards">
      <div class="card green"><div class="label">×—×•×–×™× ×¤×¢×™×œ×™×</div><div class="value" id="stat-active">â€”</div></div>
      <div class="card blue"><div class="label">×”×›× ×¡×” ×—×•×“×©×™×ª</div><div class="value" id="stat-income">â€”</div><div class="sub">â‚ª ×œ×—×•×“×©</div></div>
      <div class="card orange"><div class="label">××¡×ª×™×™××™× ×‘×§×¨×•×‘</div><div class="value" id="stat-soon">â€”</div><div class="sub">×ª×•×š 60 ×™×•×</div></div>
      <div class="card"><div class="label">×¤×’×™ ×ª×•×§×£</div><div class="value" id="stat-expired">â€”</div></div>
    </div>

    <div id="expiring-alert" style="display:none"></div>

    <div class="section-title">ğŸ“‹ ×›×œ ×”×—×•×–×™×</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>×©×•×›×¨</th>
            <th>× ×›×¡</th>
            <th>×ª×—×™×œ×”</th>
            <th>×¡×™×•×</th>
            <th>×©×›×¨ ×—×•×“×©×™</th>
            <th>×¡×˜×˜×•×¡</th>
            <th>×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody id="contracts-table-body">
          <tr><td colspan="7" class="empty">×˜×•×¢×Ÿ...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CONTRACTS LIST -->
  <div id="page-contracts" class="page">
    <div class="toolbar">
      <input type="text" id="search-input" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× / × ×›×¡..." oninput="filterContracts()">
      <button class="btn btn-primary" onclick="showPage('add')">+ ×”×•×¡×£ ×—×•×–×”</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>×©×•×›×¨</th>
            <th>× ×›×¡</th>
            <th>×ª×—×™×œ×”</th>
            <th>×¡×™×•×</th>
            <th>×©×›×¨ ×—×•×“×©×™</th>
            <th>×¡×˜×˜×•×¡</th>
            <th>×¤×¢×•×œ×•×ª</th>
          </tr>
        </thead>
        <tbody id="contracts-list-body">
          <tr><td colspan="7" class="empty">×˜×•×¢×Ÿ...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CONTRACT DETAIL -->
  <div id="page-contract" class="page">

    <div class="back-bar">
      <button id="detail-back-btn" onclick="showPage('dashboard')">â† ×—×–×¨×”</button>
      <h2 id="detail-heading"></h2>
      <span id="detail-status-badge"></span>
    </div>

    <div class="detail-grid" id="detail-grid"></div>

    <div class="detail-actions">
      <button class="btn btn-secondary" onclick="editContract(currentContractId)">âœï¸ ×¢×¨×•×š ×—×•×–×”</button>
      <button class="btn btn-sm" id="detail-pdf-btn" style="display:none; background:#8e44ad;color:white;padding:8px 16px;border-radius:8px;border:none;cursor:pointer;font-size:0.85rem;" onclick="openContractPdf()">ğŸ“„ ×¤×ª×— PDF</button>
      <button class="btn btn-danger" onclick="deleteContractDetail()">ğŸ—‘ï¸ ××—×§ ×—×•×–×”</button>
    </div>

    <div class="sub-tabs">
      <button class="sub-tab active" onclick="showDetailTab('payments')">ğŸ’° ×ª×©×œ×•××™×</button>
      <button class="sub-tab" onclick="showDetailTab('events')">ğŸ“‹ ×™×•××Ÿ ××™×¨×•×¢×™×</button>
    </div>

    <!-- DETAIL PAYMENTS -->
    <div id="detail-sub-payments" class="sub-page active">
      <div style="display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap">
        <button class="btn btn-primary" onclick="toggleDetailAddPayment()">+ ×”×•×¡×£ ×ª×©×œ×•×</button>
        <button class="btn btn-secondary" onclick="generateMonthlyDetail()">âš¡ ×¦×•×¨ ×ª×©×œ×•××™× ×—×•×“×©×™×™×</button>
      </div>

      <div class="add-form-inline" id="detail-add-payment-form">
        <div class="form-row" style="grid-template-columns:1fr 1fr 1fr; margin-bottom:10px">
          <div class="form-group"><label>×ª××¨×™×š ×™×¢×“</label><input type="date" id="dpf-date"></div>
          <div class="form-group"><label>×¡×›×•× (â‚ª)</label><input type="number" id="dpf-amount" placeholder="0"></div>
          <div class="form-group"><label>×”×¢×¨×•×ª</label><input type="text" id="dpf-notes" placeholder="××•×¤×¦×™×•× ×œ×™"></div>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn btn-primary" onclick="addDetailPayment()">×©××•×¨</button>
          <button class="btn btn-secondary" onclick="toggleDetailAddPayment()">×‘×™×˜×•×œ</button>
        </div>
      </div>

      <div class="pay-summary" id="detail-pay-summary"></div>

      <div class="table-wrap">
        <table>
          <thead><tr><th>×ª××¨×™×š ×™×¢×“</th><th>×¡×›×•×</th><th>×¡×˜×˜×•×¡</th><th>×ª××¨×™×š ×ª×©×œ×•×</th><th>×”×¢×¨×•×ª</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
          <tbody id="detail-payments-tbody"><tr><td colspan="6" class="empty">×˜×•×¢×Ÿ...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- DETAIL EVENTS -->
    <div id="detail-sub-events" class="sub-page">
      <div style="display:flex; gap:10px; margin-bottom:14px">
        <button class="btn btn-primary" onclick="toggleDetailAddEvent()">+ ×”×•×¡×£ ××™×¨×•×¢</button>
      </div>

      <div class="add-form-inline" id="detail-add-event-form">
        <div class="form-row" style="grid-template-columns:1fr 1fr; margin-bottom:10px">
          <div class="form-group"><label>×ª××¨×™×š</label><input type="date" id="def-date"></div>
          <div class="form-group"><label>×¡×•×’ ××™×¨×•×¢</label>
            <select id="def-type">
              <option value="maintenance">ğŸ”§ ×ª×™×§×•×Ÿ / ×ª×—×–×•×§×”</option>
              <option value="rent-increase">ğŸ“ˆ ×”×¢×œ××ª ×©×›"×“</option>
              <option value="notice">ğŸ“¬ ×”×•×“×¢×” ×œ×©×•×›×¨</option>
              <option value="payment-issue">âš ï¸ ×‘×¢×™×™×ª ×ª×©×œ×•×</option>
              <option value="other">ğŸ“ ××—×¨</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:10px">
          <label>×ª×™××•×¨</label>
          <textarea id="def-desc" placeholder="×ª××¨ ××ª ×”××™×¨×•×¢..."></textarea>
        </div>
        <div style="display:flex; gap:8px">
          <button class="btn btn-primary" onclick="saveDetailEvent()">×©××•×¨</button>
          <button class="btn btn-secondary" onclick="toggleDetailAddEvent()">×‘×™×˜×•×œ</button>
        </div>
      </div>

      <div id="detail-events-list"></div>
    </div>
  </div>

  <!-- PAYMENTS & EVENTS -->
  <div id="page-payments" class="page">

    <div class="contract-selector">
      <label>×‘×—×¨ ×—×•×–×”:</label>
      <select id="pay-contract-select" onchange="loadContractPaymentsView()">
        <option value="">â€” ×‘×—×¨ ×©×•×›×¨ â€”</option>
      </select>
    </div>

    <div id="pay-contract-info" style="display:none">
      <div class="contract-info-bar" id="pay-info-bar"></div>

      <div class="sub-tabs">
        <button class="sub-tab active" onclick="showSubTab('payments')">ğŸ’° ×ª×©×œ×•××™×</button>
        <button class="sub-tab" onclick="showSubTab('events')">ğŸ“‹ ×™×•××Ÿ ××™×¨×•×¢×™×</button>
      </div>

      <!-- PAYMENTS SUB-TAB -->
      <div id="sub-payments" class="sub-page active">
        <div style="display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap">
          <button class="btn btn-primary" onclick="toggleAddPayment()">+ ×”×•×¡×£ ×ª×©×œ×•×</button>
          <button class="btn btn-secondary" onclick="generateMonthly()">âš¡ ×¦×•×¨ ×ª×©×œ×•××™× ×—×•×“×©×™×™× ××•×˜×•××˜×™×ª</button>
        </div>

        <div class="add-form-inline" id="add-payment-form">
          <div class="form-row" style="grid-template-columns:1fr 1fr 1fr; margin-bottom:10px">
            <div class="form-group">
              <label>×ª××¨×™×š ×™×¢×“</label>
              <input type="date" id="pf-date">
            </div>
            <div class="form-group">
              <label>×¡×›×•× (â‚ª)</label>
              <input type="number" id="pf-amount" placeholder="0">
            </div>
            <div class="form-group">
              <label>×”×¢×¨×•×ª</label>
              <input type="text" id="pf-notes" placeholder="××•×¤×¦×™×•× ×œ×™">
            </div>
          </div>
          <div style="display:flex; gap:8px">
            <button class="btn btn-primary" onclick="addPayment()">×©××•×¨</button>
            <button class="btn btn-secondary" onclick="toggleAddPayment()">×‘×™×˜×•×œ</button>
          </div>
        </div>

        <div class="pay-summary" id="pay-summary"></div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>×ª××¨×™×š ×™×¢×“</th>
                <th>×¡×›×•×</th>
                <th>×¡×˜×˜×•×¡</th>
                <th>×ª××¨×™×š ×ª×©×œ×•×</th>
                <th>×”×¢×¨×•×ª</th>
                <th>×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody id="payments-tbody">
              <tr><td colspan="6" class="empty">×‘×—×¨ ×—×•×–×” ×›×“×™ ×œ×¨××•×ª ×ª×©×œ×•××™×</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- EVENTS SUB-TAB -->
      <div id="sub-events" class="sub-page">
        <div style="display:flex; gap:10px; margin-bottom:14px">
          <button class="btn btn-primary" onclick="toggleAddEvent()">+ ×”×•×¡×£ ××™×¨×•×¢</button>
        </div>

        <div class="add-form-inline" id="add-event-form">
          <div class="form-row" style="grid-template-columns:1fr 1fr; margin-bottom:10px">
            <div class="form-group">
              <label>×ª××¨×™×š</label>
              <input type="date" id="ef-date">
            </div>
            <div class="form-group">
              <label>×¡×•×’ ××™×¨×•×¢</label>
              <select id="ef-type">
                <option value="maintenance">ğŸ”§ ×ª×™×§×•×Ÿ / ×ª×—×–×•×§×”</option>
                <option value="rent-increase">ğŸ“ˆ ×”×¢×œ××ª ×©×›"×“</option>
                <option value="notice">ğŸ“¬ ×”×•×“×¢×” ×œ×©×•×›×¨</option>
                <option value="payment-issue">âš ï¸ ×‘×¢×™×™×ª ×ª×©×œ×•×</option>
                <option value="other">ğŸ“ ××—×¨</option>
              </select>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:10px">
            <label>×ª×™××•×¨</label>
            <textarea id="ef-desc" placeholder="×ª××¨ ××ª ×”××™×¨×•×¢..."></textarea>
          </div>
          <div style="display:flex; gap:8px">
            <button class="btn btn-primary" onclick="saveEvent()">×©××•×¨</button>
            <button class="btn btn-secondary" onclick="toggleAddEvent()">×‘×™×˜×•×œ</button>
          </div>
        </div>

        <div id="events-list"></div>
      </div>
    </div>

    <div id="pay-empty" style="padding:40px; text-align:center; color:#aaa">
      <div style="font-size:3rem; margin-bottom:10px">ğŸ’³</div>
      <div>×‘×—×¨ ×—×•×–×” ××”×¨×©×™××” ×œ××¢×œ×”</div>
    </div>
  </div>

  <!-- SCAN PDF -->
  <div id="page-scan" class="page">
    <div class="form-box">
      <div class="section-title">ğŸ“‚ ×¡×¨×™×§×ª ×ª×™×§×™×™×ª ×—×•×–×™×</div>
      <div class="form-row">
        <div class="form-group" style="grid-column:1/-1">
          <label>× ×ª×™×‘ ×œ×ª×™×§×™×™×”</label>
          <input type="text" id="scan-folder" value="C:\Users\gilin\Desktop\claude\×ª×•×‘×œ 22\×—×•×–×™ ×©×›×™×¨×•×™×•×ª" style="direction:ltr">
        </div>
      </div>
      <button class="btn btn-secondary" onclick="scanFolder()">×¡×¨×•×§ ×ª×™×§×™×™×”</button>
    </div>

    <div class="form-box">
      <div class="section-title">ğŸ“„ ×”×¢×œ××ª ×§×•×‘×¥ PDF</div>
      <input type="file" id="pdf-file" accept=".pdf" style="margin-bottom:10px">
      <br>
      <button class="btn btn-secondary" onclick="uploadPdf()">× ×ª×— PDF</button>
    </div>

    <div id="scan-results"></div>
  </div>

  <!-- ADD CONTRACT -->
  <div id="page-add" class="page">
    <div class="form-box">
      <div class="section-title">âœï¸ ×”×•×¡×£ / ×¢×¨×•×š ×—×•×–×”</div>
      <input type="hidden" id="edit-id">
      <div class="form-row">
        <div class="form-group">
          <label>×©× ×©×•×›×¨</label>
          <input type="text" id="f-tenant" placeholder="×©× ××œ×">
        </div>
        <div class="form-group">
          <label>× ×›×¡ / ×›×ª×•×‘×ª</label>
          <input type="text" id="f-property" placeholder="×›×ª×•×‘×ª ×”× ×›×¡">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>×ª××¨×™×š ×ª×—×™×œ×”</label>
          <input type="date" id="f-start">
        </div>
        <div class="form-group">
          <label>×ª××¨×™×š ×¡×™×•×</label>
          <input type="date" id="f-end">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>×©×›×¨ ×—×•×“×©×™ (â‚ª)</label>
          <input type="number" id="f-rent" placeholder="5000">
        </div>
        <div class="form-group">
          <label>××˜×‘×¢</label>
          <select id="f-currency">
            <option value="ILS">â‚ª ×©×§×œ</option>
            <option value="USD">$ ×“×•×œ×¨</option>
            <option value="EUR">â‚¬ ×™×•×¨×•</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:8px">
        <button class="btn btn-primary" onclick="saveContract()">×©××•×¨ ×—×•×–×”</button>
        <button class="btn btn-secondary" onclick="clearForm()">× ×§×”</button>
      </div>
    </div>
  </div>

</div>

<script>
const API = '/api';
let allContracts = [];
let currentContractId = null;
let editingEventId = null;

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let prevPage = 'dashboard';

function showPage(name) {
  const cur = document.querySelector('.page.active');
  if (cur && cur.id !== 'page-' + name) prevPage = cur.id.replace('page-', '');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  const navIdx = ['dashboard','contracts','payments','scan','add'].indexOf(name);
  if (navIdx >= 0) document.querySelectorAll('nav button')[navIdx].classList.add('active');
  if (name === 'dashboard') loadDashboard();
  if (name === 'contracts') loadContracts();
  if (name === 'payments') initPaymentsPage();
}

function showSubTab(name) {
  document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.sub-page').forEach(p => p.classList.remove('active'));
  document.getElementById('sub-' + name).classList.add('active');
  const idx = ['payments','events'].indexOf(name);
  document.querySelectorAll('.sub-tab')[idx].classList.add('active');
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmt(n) {
  if (!n) return 'â€”';
  return Number(n).toLocaleString('he-IL');
}
function fmtDate(d) {
  if (!d) return 'â€”';
  const [y,m,day] = d.split('-');
  return `${day}/${m}/${y}`;
}
function statusBadge(endDate) {
  if (!endDate) return '<span class="badge">â€”</span>';
  const today = new Date().toISOString().split('T')[0];
  const in60 = new Date(Date.now() + 60*24*60*60*1000).toISOString().split('T')[0];
  if (endDate < today) return '<span class="badge expired">×¤×’ ×ª×•×§×£</span>';
  if (endDate <= in60) return '<span class="badge soon">××¡×ª×™×™× ×‘×§×¨×•×‘</span>';
  return '<span class="badge active">×¤×¢×™×œ</span>';
}
function rowClass(endDate) {
  if (!endDate) return '';
  const today = new Date().toISOString().split('T')[0];
  const in60 = new Date(Date.now() + 60*24*60*60*1000).toISOString().split('T')[0];
  if (endDate < today) return 'expired-row';
  if (endDate <= in60) return 'expiring-soon';
  return '';
}

function contractRow(c, forDashboard = false) {
  return `<tr class="${rowClass(c.end_date)}" style="cursor:pointer" onclick="showContractDetail(${c.id}, event)">
    <td>${c.tenant_name || 'â€”'}</td>
    <td>${c.property || 'â€”'}</td>
    <td>${fmtDate(c.start_date)}</td>
    <td>${fmtDate(c.end_date)}</td>
    <td>${c.monthly_rent ? 'â‚ª' + fmt(c.monthly_rent) : 'â€”'}</td>
    <td>${statusBadge(c.end_date)}</td>
    <td onclick="event.stopPropagation()">
      ${c.pdf_path ? `<button class="btn btn-sm" style="background:#8e44ad;color:white" onclick="window.open('${API}/contracts/${c.id}/pdf','_blank')">ğŸ“„ PDF</button>` : ''}
      <button class="btn btn-secondary btn-sm" onclick="editContract(${c.id})">×¢×¨×•×š</button>
      <button class="btn btn-danger btn-sm" onclick="deleteContract(${c.id})">××—×§</button>
    </td>
  </tr>`;
}

// â”€â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboard() {
  const data = await fetch(API + '/dashboard').then(r => r.json());
  document.getElementById('stat-active').textContent = data.active;
  document.getElementById('stat-income').textContent = 'â‚ª' + fmt(data.monthlyIncome);
  document.getElementById('stat-soon').textContent = data.expiringSoon;
  document.getElementById('stat-expired').textContent = data.expired;

  allContracts = data.contracts;

  if (data.expiringSoonList.length > 0) {
    const names = data.expiringSoonList.map(c => c.tenant_name || c.property).join(', ');
    document.getElementById('expiring-alert').style.display = 'block';
    document.getElementById('expiring-alert').innerHTML =
      `<div class="alert alert-warning">âš ï¸ ×—×•×–×™× ×”××¡×ª×™×™××™× ×ª×•×š 60 ×™×•×: <strong>${names}</strong></div>`;
  }

  const tbody = document.getElementById('contracts-table-body');
  if (data.contracts.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty"><div class="icon">ğŸ“­</div>××™×Ÿ ×—×•×–×™× ×¢×“×™×™×Ÿ</div></td></tr>';
  } else {
    tbody.innerHTML = data.contracts.map(c => contractRow(c)).join('');
  }
}

// â”€â”€â”€ Contracts List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadContracts() {
  const data = await fetch(API + '/contracts').then(r => r.json());
  allContracts = data;
  renderContractsList(data);
}

function renderContractsList(list) {
  const tbody = document.getElementById('contracts-list-body');
  if (list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7"><div class="empty"><div class="icon">ğŸ“­</div>××™×Ÿ ×—×•×–×™×</div></td></tr>';
  } else {
    tbody.innerHTML = list.map(c => contractRow(c)).join('');
  }
}

function filterContracts() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const filtered = allContracts.filter(c =>
    (c.tenant_name || '').toLowerCase().includes(q) ||
    (c.property || '').toLowerCase().includes(q)
  );
  renderContractsList(filtered);
}

// â”€â”€â”€ Add / Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function editContract(id) {
  const c = await fetch(API + '/contracts/' + id).then(r => r.json());
  document.getElementById('edit-id').value = c.id;
  document.getElementById('f-tenant').value = c.tenant_name || '';
  document.getElementById('f-property').value = c.property || '';
  document.getElementById('f-start').value = c.start_date || '';
  document.getElementById('f-end').value = c.end_date || '';
  document.getElementById('f-rent').value = c.monthly_rent || '';
  document.getElementById('f-currency').value = c.currency || 'ILS';
  showPage('add');
}

async function saveContract() {
  const id = document.getElementById('edit-id').value;
  const payload = {
    tenant_name: document.getElementById('f-tenant').value,
    property: document.getElementById('f-property').value,
    start_date: document.getElementById('f-start').value,
    end_date: document.getElementById('f-end').value,
    monthly_rent: parseFloat(document.getElementById('f-rent').value) || null,
    currency: document.getElementById('f-currency').value
  };

  if (id) {
    await fetch(API + '/contracts/' + id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  } else {
    await fetch(API + '/contracts', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  }
  clearForm();
  showPage('dashboard');
}

function clearForm() {
  document.getElementById('edit-id').value = '';
  ['f-tenant','f-property','f-start','f-end','f-rent'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('f-currency').value = 'ILS';
}

async function deleteContract(id) {
  if (!confirm('×œ××—×•×§ ×—×•×–×” ×–×”?')) return;
  await fetch(API + '/contracts/' + id, { method: 'DELETE' });
  loadDashboard();
}

// â”€â”€â”€ Scan PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function scanFolder() {
  const folder = document.getElementById('scan-folder').value;
  document.getElementById('scan-results').innerHTML = '<p>×¡×•×¨×§...</p>';
  try {
    const res = await fetch(API + '/scan-folder', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ folderPath: folder })
    });
    const results = await res.json();
    if (results.error) {
      document.getElementById('scan-results').innerHTML = `<div class="alert alert-warning">${results.error}</div>`;
      return;
    }
    renderScanResults(results);
  } catch(e) {
    document.getElementById('scan-results').innerHTML = `<div class="alert alert-warning">×©×’×™××”: ${e.message}</div>`;
  }
}

async function uploadPdf() {
  const file = document.getElementById('pdf-file').files[0];
  if (!file) { alert('×‘×—×¨ ×§×•×‘×¥ PDF'); return; }
  const formData = new FormData();
  formData.append('pdf', file);
  document.getElementById('scan-results').innerHTML = '<p>×× ×ª×—...</p>';
  const res = await fetch(API + '/upload-pdf', { method: 'POST', body: formData });
  const result = await res.json();
  renderScanResults([result]);
}

function renderScanResults(results) {
  const today = new Date().toISOString().split('T')[0];
  const html = results.map((r, i) => `
    <div class="scan-result">
      <h4>ğŸ“„ ${r.filename}</h4>
      <div class="meta">
        ×ª××¨×™×›×™× ×©×–×•×”×•: ${r.dates.join(', ') || '×œ× × ××¦××•'} |
        ×¡×›×•××™× ×©×–×•×”×•: ${r.amounts.map(a => 'â‚ª'+fmt(a)).join(', ') || '×œ× × ××¦××•'}
        ${r.tenant ? ' | ×©×•×›×¨: ' + r.tenant : ''}
      </div>
      <div class="inline-form">
        <input class="wide" type="text" placeholder="×©× ×©×•×›×¨" id="sr-tenant-${i}" value="${r.tenant || ''}">
        <input class="wide" type="text" placeholder="× ×›×¡" id="sr-prop-${i}" value="${r.property || ''}">
        <input type="date" id="sr-start-${i}" value="${r.start_date || ''}">
        <input type="date" id="sr-end-${i}" value="${r.end_date || ''}">
        <input type="number" placeholder="×©×›"×“" id="sr-rent-${i}" value="${r.monthly_rent || ''}" style="width:100px">
        <button class="btn btn-success btn-sm" onclick="importContract(${i}, '${r.filename}')">×™×™×‘× ×œDB</button>
      </div>
    </div>
  `).join('');
  document.getElementById('scan-results').innerHTML = html || '<div class="empty">×œ× × ××¦××• ×§×‘×¦×™×</div>';
}

async function importContract(i, filename) {
  const payload = {
    tenant_name: document.getElementById('sr-tenant-'+i).value,
    property: document.getElementById('sr-prop-'+i).value,
    start_date: document.getElementById('sr-start-'+i).value,
    end_date: document.getElementById('sr-end-'+i).value,
    monthly_rent: parseFloat(document.getElementById('sr-rent-'+i).value) || null,
    pdf_path: filename
  };
  const res = await fetch(API + '/import-contract', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (data.id) {
    alert('âœ… ×—×•×–×” ×™×•×‘× ×‘×”×¦×œ×—×”! (ID: ' + data.id + ')');
  } else {
    alert('×©×’×™××”: ' + JSON.stringify(data));
  }
}

// â”€â”€â”€ Contract Detail Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let detailEditingEventId = null;

async function showContractDetail(id, e) {
  if (e) e.stopPropagation();
  currentContractId = id;
  const c = await fetch(API + '/contracts/' + id).then(r => r.json());

  // Back button label
  document.getElementById('detail-back-btn').textContent = 'â† ×—×–×¨×”';
  document.getElementById('detail-back-btn').onclick = () => showPage(prevPage);

  // Heading
  document.getElementById('detail-heading').textContent = `${c.tenant_name || 'â€”'}  â€¢  ${c.property || 'â€”'}`;
  document.getElementById('detail-status-badge').innerHTML = statusBadge(c.end_date);

  // Detail grid
  const daysLeft = c.end_date ? Math.ceil((new Date(c.end_date) - new Date()) / 86400000) : null;
  const daysStr = daysLeft === null ? 'â€”' : daysLeft < 0 ? `×¤×’ ×œ×¤× ×™ ${Math.abs(daysLeft)} ×™××™×` : `${daysLeft} ×™××™×`;
  document.getElementById('detail-grid').innerHTML = `
    <div class="detail-field"><div class="df-label">×©×•×›×¨</div><div class="df-value">${c.tenant_name || 'â€”'}</div></div>
    <div class="detail-field"><div class="df-label">× ×›×¡ / ×›×ª×•×‘×ª</div><div class="df-value">${c.property || 'â€”'}</div></div>
    <div class="detail-field"><div class="df-label">×ª×—×™×œ×ª ×©×›×™×¨×•×ª</div><div class="df-value">${fmtDate(c.start_date)}</div></div>
    <div class="detail-field"><div class="df-label">×¡×™×•× ×©×›×™×¨×•×ª</div><div class="df-value">${fmtDate(c.end_date)}</div></div>
    <div class="detail-field"><div class="df-label">×™××™× ×œ×¡×™×•×</div><div class="df-value">${daysStr}</div></div>
    <div class="detail-field"><div class="df-label">×©×›"×“ ×—×•×“×©×™</div><div class="df-value">${c.monthly_rent ? 'â‚ª' + fmt(c.monthly_rent) : 'â€”'}</div></div>
    <div class="detail-field"><div class="df-label">××˜×‘×¢</div><div class="df-value">${c.currency || 'ILS'}</div></div>
    <div class="detail-field"><div class="df-label">× ×•×¡×£ ×‘</div><div class="df-value" style="font-size:0.85rem;font-weight:400">${c.created_at ? c.created_at.split(' ')[0] : 'â€”'}</div></div>
  `;

  // PDF button
  const pdfBtn = document.getElementById('detail-pdf-btn');
  if (c.pdf_path) { pdfBtn.style.display = 'inline-flex'; pdfBtn.onclick = () => window.open(API + '/contracts/' + id + '/pdf', '_blank'); }
  else pdfBtn.style.display = 'none';

  // Prefill payment defaults
  document.getElementById('dpf-amount').value = c.monthly_rent || '';
  document.getElementById('dpf-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('def-date').value = new Date().toISOString().split('T')[0];

  // Reset sub-tabs
  showDetailTab('payments');

  showPage('contract');
  await loadDetailPayments();
  await loadDetailEvents();
}

function openContractPdf() {
  window.open(API + '/contracts/' + currentContractId + '/pdf', '_blank');
}

function showDetailTab(name) {
  document.querySelectorAll('#page-contract .sub-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('#page-contract .sub-page').forEach(p => p.classList.remove('active'));
  document.getElementById('detail-sub-' + name).classList.add('active');
  const idx = ['payments','events'].indexOf(name);
  document.querySelectorAll('#page-contract .sub-tab')[idx].classList.add('active');
}

async function loadDetailPayments() {
  if (!currentContractId) return;
  const payments = await fetch(API + '/payments/' + currentContractId).then(r => r.json());
  const today = new Date().toISOString().split('T')[0];

  const paid   = payments.filter(p => p.paid);
  const unpaid = payments.filter(p => !p.paid && p.due_date >= today);
  const late   = payments.filter(p => !p.paid && p.due_date < today);

  document.getElementById('detail-pay-summary').innerHTML = `
    <div class="pay-chip paid">âœ… ×©×•×œ×: â‚ª${fmt(paid.reduce((s,p)=>s+(p.amount||0),0))} (${paid.length})</div>
    <div class="pay-chip unpaid">â³ ×××ª×™×Ÿ: â‚ª${fmt(unpaid.reduce((s,p)=>s+(p.amount||0),0))} (${unpaid.length})</div>
    ${late.length ? `<div class="pay-chip late">âš ï¸ ×‘××™×—×•×¨: â‚ª${fmt(late.reduce((s,p)=>s+(p.amount||0),0))} (${late.length})</div>` : ''}
  `;

  const tbody = document.getElementById('detail-payments-tbody');
  if (payments.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty">××™×Ÿ ×ª×©×œ×•××™×. ×œ×—×¥ "×¦×•×¨ ×ª×©×œ×•××™× ×—×•×“×©×™×™×" ×œ×”×¤×§×” ××•×˜×•××˜×™×ª.</div></td></tr>';
    return;
  }
  tbody.innerHTML = payments.map(p => {
    const isLate = !p.paid && p.due_date < today;
    return `<tr style="${isLate?'background:#fff8f8':p.paid?'background:#f8fff9':''}">
      <td>${fmtDate(p.due_date)}</td>
      <td>â‚ª${fmt(p.amount)}</td>
      <td>${p.paid ? '<span class="badge active">×©×•×œ×</span>' : isLate ? '<span class="badge expired">×‘××™×—×•×¨</span>' : '<span class="badge soon">×××ª×™×Ÿ</span>'}</td>
      <td>${p.paid_date ? fmtDate(p.paid_date) : 'â€”'}</td>
      <td style="color:#777;font-size:0.8rem">${p.notes||''}</td>
      <td>
        ${p.paid
          ? `<button class="btn btn-sm" style="background:#eee;color:#555" onclick="detailUnpay(${p.id})">×‘×˜×œ</button>`
          : `<button class="btn btn-success btn-sm" onclick="detailPay(${p.id})">×©×•×œ×</button>`}
        <button class="btn btn-danger btn-sm" onclick="detailDelPayment(${p.id})">××—×§</button>
      </td>
    </tr>`;
  }).join('');
}

function toggleDetailAddPayment() {
  document.getElementById('detail-add-payment-form').classList.toggle('open');
}
async function addDetailPayment() {
  const due_date = document.getElementById('dpf-date').value;
  const amount   = parseFloat(document.getElementById('dpf-amount').value);
  const notes    = document.getElementById('dpf-notes').value;
  if (!due_date || !amount) { alert('× × ×œ××œ× ×ª××¨×™×š ×•×¡×›×•×'); return; }
  await fetch(API + '/payments', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ contract_id: currentContractId, due_date, amount, notes }) });
  document.getElementById('dpf-notes').value = '';
  document.getElementById('detail-add-payment-form').classList.remove('open');
  loadDetailPayments();
}
async function detailPay(id)        { await fetch(API+'/payments/'+id+'/pay',   {method:'PUT'}); loadDetailPayments(); }
async function detailUnpay(id)      { await fetch(API+'/payments/'+id+'/unpay', {method:'PUT'}); loadDetailPayments(); }
async function detailDelPayment(id) { if(!confirm('×œ××—×•×§?')) return; await fetch(API+'/payments/'+id,{method:'DELETE'}); loadDetailPayments(); }
async function generateMonthlyDetail() {
  const res = await fetch(API+'/payments/generate/'+currentContractId,{method:'POST'});
  const d = await res.json();
  if (d.error) { alert('×©×’×™××”: '+d.error); return; }
  alert(`× ×•×¦×¨×• ${d.inserted} ×ª×©×œ×•××™× ×—×“×©×™×`);
  loadDetailPayments();
}

let detailEvents = [];
async function loadDetailEvents() {
  if (!currentContractId) return;
  const events = await fetch(API + '/events/' + currentContractId).then(r => r.json());
  detailEvents = events;
  const container = document.getElementById('detail-events-list');
  if (events.length === 0) {
    container.innerHTML = '<div class="empty" style="padding:40px;text-align:center;color:#aaa"><div style="font-size:2.5rem">ğŸ“‹</div><div>××™×Ÿ ××™×¨×•×¢×™× ×¢×“×™×™×Ÿ</div></div>';
    return;
  }
  container.innerHTML = events.map(e => `
    <div class="scan-result" style="border-right-color:${eventColor(e.type)}">
      <div style="display:flex;align-items:flex-start;gap:12px;justify-content:space-between">
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
            <span class="event-type ${e.type}">${EVENT_LABELS[e.type]||e.type}</span>
            <span style="font-size:0.82rem;color:#888">${fmtDate(e.event_date)}</span>
          </div>
          <div style="font-size:0.88rem;color:#333;line-height:1.5">${(e.description||'').replace(/\n/g,'<br>')}</div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button class="btn btn-secondary btn-sm" onclick="startDetailEditEvent(${e.id})">×¢×¨×•×š</button>
          <button class="btn btn-danger btn-sm" onclick="detailDelEvent(${e.id})">××—×§</button>
        </div>
      </div>
    </div>
  `).join('');
}

function toggleDetailAddEvent() {
  detailEditingEventId = null;
  const form = document.getElementById('detail-add-event-form');
  form.classList.toggle('open');
  if (form.classList.contains('open')) {
    document.getElementById('def-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('def-type').value = 'maintenance';
    document.getElementById('def-desc').value = '';
  }
}
function startDetailEditEvent(id) {
  const e = detailEvents.find(ev => ev.id == id);
  if (!e) return;
  detailEditingEventId = id;
  document.getElementById("def-date").value = e.event_date;
  document.getElementById("def-type").value = e.type;
  document.getElementById("def-desc").value = e.description || "";
  document.getElementById("detail-add-event-form").classList.add("open");
}
async function saveDetailEvent() {
  const event_date  = document.getElementById('def-date').value;
  const type        = document.getElementById('def-type').value;
  const description = document.getElementById('def-desc').value;
  if (!event_date || !description.trim()) { alert('× × ×œ××œ× ×ª××¨×™×š ×•×ª×™××•×¨'); return; }
  if (detailEditingEventId) {
    await fetch(API+'/events/'+detailEditingEventId, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({event_date, type, description}) });
    detailEditingEventId = null;
  } else {
    await fetch(API+'/events', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({contract_id: currentContractId, event_date, type, description}) });
  }
  document.getElementById('detail-add-event-form').classList.remove('open');
  loadDetailEvents();
}
async function detailDelEvent(id) {
  if (!confirm('×œ××—×•×§ ××™×¨×•×¢ ×–×”?')) return;
  await fetch(API+'/events/'+id, {method:'DELETE'});
  loadDetailEvents();
}

async function deleteContractDetail() {
  if (!confirm('×œ××—×•×§ ×—×•×–×” ×–×” ×œ×¦××™×ª×•×ª?')) return;
  await fetch(API + '/contracts/' + currentContractId, { method: 'DELETE' });
  showPage(prevPage);
}

// â”€â”€â”€ Payments & Events Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function initPaymentsPage() {
  const data = await fetch(API + '/contracts').then(r => r.json());
  allContracts = data;
  const sel = document.getElementById('pay-contract-select');
  sel.innerHTML = '<option value="">â€” ×‘×—×¨ ×©×•×›×¨ â€”</option>';
  data.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = `${c.tenant_name || 'â€”'} | ${c.property || 'â€”'}`;
    sel.appendChild(opt);
  });
  if (currentContractId) {
    sel.value = currentContractId;
    loadContractPaymentsView();
  }
}

async function loadContractPaymentsView() {
  const sel = document.getElementById('pay-contract-select');
  currentContractId = sel.value;
  if (!currentContractId) {
    document.getElementById('pay-contract-info').style.display = 'none';
    document.getElementById('pay-empty').style.display = 'block';
    return;
  }
  document.getElementById('pay-empty').style.display = 'none';
  document.getElementById('pay-contract-info').style.display = 'block';

  const c = allContracts.find(x => x.id == currentContractId);
  document.getElementById('pay-info-bar').innerHTML = `
    <div class="info-item"><div class="info-label">×©×•×›×¨</div><div class="info-val">${c.tenant_name || 'â€”'}</div></div>
    <div class="info-item"><div class="info-label">× ×›×¡</div><div class="info-val">${c.property || 'â€”'}</div></div>
    <div class="info-item"><div class="info-label">×ª×—×™×œ×”</div><div class="info-val">${fmtDate(c.start_date)}</div></div>
    <div class="info-item"><div class="info-label">×¡×™×•×</div><div class="info-val">${fmtDate(c.end_date)}</div></div>
    <div class="info-item"><div class="info-label">×©×›"×“ ×—×•×“×©×™</div><div class="info-val">${c.monthly_rent ? 'â‚ª' + fmt(c.monthly_rent) : 'â€”'}</div></div>
  `;

  // Set default amount for new payment
  document.getElementById('pf-amount').value = c.monthly_rent || '';
  // Set default date to today
  document.getElementById('pf-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('ef-date').value = new Date().toISOString().split('T')[0];

  await loadPayments();
  await loadEvents();
}

async function loadPayments() {
  if (!currentContractId) return;
  const payments = await fetch(API + '/payments/' + currentContractId).then(r => r.json());
  const today = new Date().toISOString().split('T')[0];

  // Summary
  const paid = payments.filter(p => p.paid);
  const unpaid = payments.filter(p => !p.paid && p.due_date >= today);
  const late = payments.filter(p => !p.paid && p.due_date < today);
  const totalPaid = paid.reduce((s, p) => s + (p.amount || 0), 0);
  const totalUnpaid = [...unpaid, ...late].reduce((s, p) => s + (p.amount || 0), 0);

  document.getElementById('pay-summary').innerHTML = `
    <div class="pay-chip paid">âœ… ×©×•×œ×: â‚ª${fmt(totalPaid)} (${paid.length} ×ª×©×œ×•××™×)</div>
    <div class="pay-chip unpaid">â³ ×××ª×™×Ÿ: â‚ª${fmt(unpaid.reduce((s,p)=>s+(p.amount||0),0))} (${unpaid.length})</div>
    ${late.length ? `<div class="pay-chip late">âš ï¸ ×‘××™×—×•×¨: â‚ª${fmt(late.reduce((s,p)=>s+(p.amount||0),0))} (${late.length})</div>` : ''}
    <div class="pay-chip total">×¡×”"×›: â‚ª${fmt(totalPaid + totalUnpaid)}</div>
  `;

  const tbody = document.getElementById('payments-tbody');
  if (payments.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty">××™×Ÿ ×ª×©×œ×•××™× ×¢×“×™×™×Ÿ. ×œ×—×¥ "×¦×•×¨ ×ª×©×œ×•××™× ×—×•×“×©×™×™×" ×œ×”×¤×§×” ××•×˜×•××˜×™×ª.</div></td></tr>';
    return;
  }

  tbody.innerHTML = payments.map(p => {
    const isLate = !p.paid && p.due_date < today;
    const rowStyle = isLate ? 'background:#fff8f8' : (p.paid ? 'background:#f8fff9' : '');
    return `<tr style="${rowStyle}">
      <td>${fmtDate(p.due_date)}</td>
      <td>â‚ª${fmt(p.amount)}</td>
      <td>${p.paid
        ? '<span class="badge active">×©×•×œ×</span>'
        : isLate
          ? '<span class="badge expired">×‘××™×—×•×¨</span>'
          : '<span class="badge soon">×××ª×™×Ÿ</span>'
      }</td>
      <td>${p.paid_date ? fmtDate(p.paid_date) : 'â€”'}</td>
      <td style="color:#777; font-size:0.8rem">${p.notes || ''}</td>
      <td>
        ${p.paid
          ? `<button class="btn btn-sm" style="background:#eee;color:#555" onclick="unpayPayment(${p.id})">×‘×˜×œ ×ª×©×œ×•×</button>`
          : `<button class="btn btn-success btn-sm" onclick="payPayment(${p.id})">×¡××Ÿ ×›×©×•×œ×</button>`
        }
        <button class="btn btn-danger btn-sm" onclick="deletePayment(${p.id})">××—×§</button>
      </td>
    </tr>`;
  }).join('');
}

function toggleAddPayment() {
  const form = document.getElementById('add-payment-form');
  form.classList.toggle('open');
}

async function addPayment() {
  const due_date = document.getElementById('pf-date').value;
  const amount = parseFloat(document.getElementById('pf-amount').value);
  const notes = document.getElementById('pf-notes').value;
  if (!due_date || !amount) { alert('× × ×œ××œ× ×ª××¨×™×š ×•×¡×›×•×'); return; }

  await fetch(API + '/payments', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ contract_id: currentContractId, due_date, amount, notes })
  });
  document.getElementById('pf-notes').value = '';
  document.getElementById('add-payment-form').classList.remove('open');
  loadPayments();
}

async function payPayment(id) {
  await fetch(API + '/payments/' + id + '/pay', { method: 'PUT' });
  loadPayments();
}

async function unpayPayment(id) {
  await fetch(API + '/payments/' + id + '/unpay', { method: 'PUT' });
  loadPayments();
}

async function deletePayment(id) {
  if (!confirm('×œ××—×•×§ ×ª×©×œ×•× ×–×”?')) return;
  await fetch(API + '/payments/' + id, { method: 'DELETE' });
  loadPayments();
}

async function generateMonthly() {
  if (!currentContractId) return;
  const res = await fetch(API + '/payments/generate/' + currentContractId, { method: 'POST' });
  const data = await res.json();
  if (data.error) { alert('×©×’×™××”: ' + data.error); return; }
  alert(`× ×•×¦×¨×• ${data.inserted} ×ª×©×œ×•××™× ×—×•×“×©×™×™× ×—×“×©×™×`);
  loadPayments();
}

// â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const EVENT_LABELS = {
  'maintenance':   'ğŸ”§ ×ª×™×§×•×Ÿ / ×ª×—×–×•×§×”',
  'rent-increase': 'ğŸ“ˆ ×”×¢×œ××ª ×©×›"×“',
  'notice':        'ğŸ“¬ ×”×•×“×¢×” ×œ×©×•×›×¨',
  'payment-issue': 'âš ï¸ ×‘×¢×™×™×ª ×ª×©×œ×•×',
  'other':         'ğŸ“ ××—×¨'
};

async function loadEvents() {
  if (!currentContractId) return;
  const events = await fetch(API + '/events/' + currentContractId).then(r => r.json());
  const container = document.getElementById('events-list');

  if (events.length === 0) {
    container.innerHTML = '<div class="empty" style="padding:40px; text-align:center; color:#aaa"><div style="font-size:2.5rem">ğŸ“‹</div><div>××™×Ÿ ××™×¨×•×¢×™× ×¢×“×™×™×Ÿ</div></div>';
    return;
  }

  container.innerHTML = events.map(e => `
    <div class="scan-result" style="border-right-color: ${eventColor(e.type)}">
      <div style="display:flex; align-items:flex-start; gap:12px; justify-content:space-between">
        <div style="flex:1">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:6px">
            <span class="event-type ${e.type}">${EVENT_LABELS[e.type] || e.type}</span>
            <span style="font-size:0.82rem; color:#888">${fmtDate(e.event_date)}</span>
          </div>
          <div style="font-size:0.88rem; color:#333; line-height:1.5">${(e.description || '').replace(/\n/g,'<br>')}</div>
        </div>
        <div style="display:flex; gap:6px; flex-shrink:0">
          <button class="btn btn-secondary btn-sm" onclick="startEditEvent(${e.id}, '${e.event_date}', '${e.type}', ${JSON.stringify(e.description || '')})">×¢×¨×•×š</button>
          <button class="btn btn-danger btn-sm" onclick="deleteEvent(${e.id})">××—×§</button>
        </div>
      </div>
    </div>
  `).join('');
}

function eventColor(type) {
  const colors = { maintenance:'#e74c3c', 'rent-increase':'#f39c12', notice:'#2ecc71', 'payment-issue':'#9b59b6', other:'#95a5a6' };
  return colors[type] || '#3498db';
}

function toggleAddEvent() {
  editingEventId = null;
  const form = document.getElementById('add-event-form');
  form.classList.toggle('open');
  if (form.classList.contains('open')) {
    document.getElementById('ef-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('ef-type').value = 'maintenance';
    document.getElementById('ef-desc').value = '';
  }
}

function startEditEvent(id, date, type, description) {
  editingEventId = id;
  document.getElementById('ef-date').value = date;
  document.getElementById('ef-type').value = type;
  document.getElementById('ef-desc').value = description;
  document.getElementById('add-event-form').classList.add('open');
  document.getElementById('add-event-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function saveEvent() {
  const event_date = document.getElementById('ef-date').value;
  const type = document.getElementById('ef-type').value;
  const description = document.getElementById('ef-desc').value;
  if (!event_date || !description.trim()) { alert('× × ×œ××œ× ×ª××¨×™×š ×•×ª×™××•×¨'); return; }

  if (editingEventId) {
    await fetch(API + '/events/' + editingEventId, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ event_date, type, description })
    });
    editingEventId = null;
  } else {
    await fetch(API + '/events', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ contract_id: currentContractId, event_date, type, description })
    });
  }
  document.getElementById('add-event-form').classList.remove('open');
  loadEvents();
}

async function deleteEvent(id) {
  if (!confirm('×œ××—×•×§ ××™×¨×•×¢ ×–×”?')) return;
  await fetch(API + '/events/' + id, { method: 'DELETE' });
  loadEvents();
}

// Init
loadDashboard();
</script>
</body>
</html>
